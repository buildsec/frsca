---
name: CI
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - main
  workflow_dispatch: {}
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: mfinelli/setup-shfmt@v1
      - name: Lint all
        run: make lint

  setup:
    runs-on: ubuntu-latest
    needs:
      lint
    name: Test FRSCA Installation
    steps:
      - uses: actions/checkout@v3
      - name: Setup go
        uses: actions/setup-go@v3
        with:
          go-version: "~1.19.0"
      - name: Vendor Dependencies
        run: |
          ./platform/vendor/vendor.sh
          ./platform/vendor/vendor-helm-all.sh
      - name: Check commit is clean
        run: test -z "$(git status --porcelain)" || (git status; git diff; false)
      - name: Start minikube
        run: |
          make setup-minikube
      - name: Try the cluster !
        run: kubectl get pods -A
      - name: Generate certs
        run: |
          make setup-certs
      - name: Setup Tekton Pipeline and Chains
        run: |
          make setup-tekton-chains
      - name: Setup Spire
        run: |
          make setup-spire
      - name: Setup Vault
        run: |
          make setup-vault
      - name: Setup Kyverno
        run: |
          make setup-kyverno
      - name: SLSA 1 Example
        run: |
          kubectl apply -f slsa/1/buildpacks.yaml
          kubectl create -f slsa/1/buildpacksRun.yaml
          tkn tr logs --last -f
